<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Help to draw</title>
  <style>
.box {
margin: 0px;
  padding: 0px;
  height: 500px;
  width: 500px;
  border: 0px;
   position: absolute;
  background-repeat: no-repeat; /* 避免圖片重複顯示 */
  background-position: left top; /* 将背景图像左上角对齐 */
  z-index: 1;
  opacity: 0.5;
   transform-origin: left top; /* 缩放操作的原点在左上角 */
  
}

.box2 {
margin: 0px;
  padding: 0px;
  height: 500px;
  width: 500px;
  border: 0px;
   position: absolute;
  border: 1px solid red;
  background-repeat: no-repeat; /* 避免圖片重複顯示 */
  background-position: left top; /* 将背景图像左上角对齐 */
  z-index: 9999;
  opacity: 1;
   transform-origin: left top; /* 缩放操作的原点在左上角 */
    
}

 #video-container {
		position: relative;
		width: 952px;
		height: 734px;
		margin: 0 auto;
		margin-top: 50px;
		 background-repeat: no-repeat; /* 避免圖片重複顯示 */
	}
	
	#video {
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		object-fit: cover;
		background-repeat: no-repeat; /* 避免圖片重複顯示 */
        transform-origin: 0 0; /* 统一变换原点为左上角 */
	}

	.diagonal-line {
  position: absolute;
  width: 100%;
  height: 1px;
  background-color: red;
  top: 50%;
  left: 0;
}

	 #video1 {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 10%;
      height: 10%;
      z-index: 9999;
        transform-origin: 0 0; /* 统一变换原点为左上角 */
    }

  </style>
</head>

<body>

<label for="camId">1. 選擇鏡頭：</label>
	<select id="camId"></select>
	<button onclick="startWebcam1()">連結</button>
	<br>
    <!-- 新增镜像切换按钮 -->
    <button onclick="toggleVideoMirror()">切换镜像模式</button>
    <span id="mirrorStatus">当前模式：正常</span>
	

	<script>
		var camSelect = document.getElementById('camId');
        let mirrorMode = 0; // 0:正常 1:左右下上 2:左右上下 3:右左上下 4:右左下上

		function populateCameras() {
			navigator.mediaDevices.enumerateDevices()
				.then(function(devices) {
					var videoDevices = devices.filter(function(device) {
						return device.kind === 'videoinput';
					});

					videoDevices.forEach(function(device) {
						var option = document.createElement('option');
						option.value = device.deviceId;
						option.text = device.label || 'CAM ' + (camSelect.length + 1);
						camSelect.appendChild(option);
					});
				});
		}

		function startWebcam1() {
			var camId = camSelect.value;

			if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
				navigator.mediaDevices.getUserMedia({ video: { deviceId: camId } })
					.then(function(stream) {		
						video.srcObject = stream;
						video.play();
						video1.srcObject = stream;
						video1.play();
                        updateVideoMirror();
					})
					.catch(function(error) {
						console.log('Error accessing webcam:', error);
					});
			}
		}

		populateCameras();
		
        function updateVideoMirror() {
            const video = document.getElementById('video');
            const video1 = document.getElementById('video1');
            const statusText = document.getElementById('mirrorStatus');
            let transform = '';
            let status = '';

            switch(mirrorMode) {
                case 0:
                    transform = 'none';
                    status = '正常';
                    break;
                case 1:
                    transform = 'scaleX(-1) scaleY(-1)';
                    status = '左右下上';
                    break;
                case 2:
                    transform = 'scaleX(-1)';
                    status = '左右上下';
                    break;
                case 3:
                    transform = 'scaleY(-1)';
                    status = '右左上下';
                    break;
                case 4:
                    transform = 'rotate(180deg)';
                    status = '右左下上';
                    break;
            }

            video.dataset.mirrorTransform = transform;
            video1.dataset.mirrorTransform = transform;
            
            if (!video.style.transform || video.style.transform.indexOf('matrix3d') === -1) {
                video.style.transform = transform;
                video1.style.transform = transform;
            } else {
                applyTransformWithMirror(video);
                applyTransformWithMirror(video1);
            }
            
            statusText.textContent = `当前模式：${status}`;
            // 重新定位控制点
            repositionControlPoints(video);
        }

        function applyTransformWithMirror(element) {
            const mirrorTransform = element.dataset.mirrorTransform || 'none';
            const matrixTransform = element.dataset.matrixTransform || 'none';
            element.style.transform = `${matrixTransform} ${mirrorTransform}`;
        }

        function toggleVideoMirror() {
            mirrorMode = (mirrorMode + 1) % 5;
            updateVideoMirror();
        }
	</script>

<br> 
  	<label for="file-upload"> 2. 上載圖片:</label>
	<input type="file" id="file-upload"></INPUT>
	<div id="uploadStatus">Check width and height of the image before uploading...</div>
	
	 
  <button onclick="zoomIn()">放大/i</button>
  <button onclick="zoomOut()">缩小/o</button>
  <button onclick="moveLeft()">左移/a</button>
  <button onclick="moveRight()">右移/d</button>
  <button onclick="moveUp()">上移/w</button>
  <button onclick="moveDown()">下移s</button>
 <br> 
	<br> 3. 設定圖片透明度 :
	 <button onclick="aTrans()">透明/t</button>

	<input id="slider" class="slider" type="range" min="0" max="100" step="5"
	value="50" oninput="updateOpacity(this.value)"/>  
	<button onclick="mTrans()">不透/y</button>
	<button onclick="flash_Image()">閃動/f</button>

  <video id="video1" class="video1" ></video>
  
   <div id="video-container"> 
    
 <video id="video" class="video" ></video>
 
 <div class="box" id="box"  style="margin: auto"></div>
<div class="box2" id="box2"  style="margin: auto"></div>

 </div>
  
  <script src='js2/jquery.min.js'></script>
<script src='js2/jquery-ui.min.js'></script>
<script src='js2/numeric.min.js'></script>
    <script>
// 全局存储控制点，方便重新定位
let controlPointsStore = {};

function applyTransform(element, originalPos, targetPos, callback) {
  var $ = jQuery;
  var getTransform = function(from, to) {
    var A, H, b, h, i, k, k_i, l, lhs, m, ref, rhs;
    console.assert((from.length === (ref = to.length) && ref === 4));
    A = [];
    for (i = k = 0; k < 4; i = ++k) {
      A.push([from[i].x, from[i].y, 1, 0, 0, 0, -from[i].x * to[i].x, -from[i].y * to[i].x]);
      A.push([0, 0, 0, from[i].x, from[i].y, 1, -from[i].x * to[i].y, -from[i].y * to[i].y]);
    }
    b = [];
    for (i = l = 0; l < 4; i = ++l) {
      b.push(to[i].x);
      b.push(to[i].y);
    }
    h = numeric.solve(A, b);
    H = [[h[0], h[1], 0, h[2]], [h[3], h[4], 0, h[5]], [0, 0, 1, 0], [h[6], h[7], 0, 1]];
    for (i = m = 0; m < 4; i = ++m) {
      lhs = numeric.dot(H, [from[i].x, from[i].y, 0, 1]);
      k_i = lhs[3];
      rhs = numeric.dot(k_i, [to[i].x, to[i].y, 0, 1]);
      console.assert(numeric.norm2(numeric.sub(lhs, rhs)) < 1e-9, "Not equal:", lhs, rhs);
    }
    return H;
  };

  var from = originalPos.map(p => ({ x: p[0] - originalPos[0][0], y: p[1] - originalPos[0][1] }));
  var to = targetPos.map(p => ({ x: p[0] - originalPos[0][0], y: p[1] - originalPos[0][1] }));
  var H = getTransform(from, to);
  
  var matrixTransform = "matrix3d(" + (((function() {
    var k, results;
    results = [];
    for (i = k = 0; k < 4; i = ++k) {
      results.push((function() {
        var l, results1;
        results1 = [];
        for (j = l = 0; l < 4; j = ++l) {
          results1.push(H[j][i].toFixed(20));
        }
        return results1;
      })());
    }
    return results;
  })()).join(',')) + ")";
  
  element.dataset.matrixTransform = matrixTransform;
  applyTransformWithMirror(element);
  
  if (typeof callback === "function") {
    callback(element, H);
  }
}

function makeTransformable(selector, callback) {
  var $ = jQuery;
  $(selector).each(function(i, element) {
    var $element = $(element);
    var elementId = element.id || 'video_' + i;
    
    // 生成控制点，基于元素的BoundingClientRect（视觉位置）
    var controlPoints = ['left top', 'left bottom', 'right top', 'right bottom'].map(function(position, idx) {
      var rect = element.getBoundingClientRect();
      var cp = $('<div>').css({
        border: '3px dashed red', 
        borderRadius: '3px',
        cursor: 'move',
        position: 'fixed', // 改为fixed，基于视口定位
        zIndex: 100000,
        width: '10px',
        height: '10px',
        boxSizing: 'border-box'
      }).appendTo('body');
      
      // 根据位置设置初始坐标
      var x = rect.left;
      var y = rect.top;
      if (position.includes('right')) x = rect.right - 10;
      if (position.includes('bottom')) y = rect.bottom - 10;
      
      cp.css({
        left: x + 'px',
        top: y + 'px'
      });
      
      return cp;
    });
    
    // 存储控制点
    controlPointsStore[elementId] = controlPoints;
    
    var originalPos = controlPoints.map(function(p) { 
      return [parseFloat(p.css('left')), parseFloat(p.css('top'))]; 
    });
    
    $(controlPoints).draggable({
      start: function() { 
        $element.css('pointer-events', 'none'); 
      },
      drag: function() { 
        var currentPos = controlPoints.map(function(p) { 
          return [parseFloat(p.css('left')), parseFloat(p.css('top'))]; 
        });
        applyTransform(element, originalPos, currentPos, callback); 
      },
      stop: function() {
        var currentPos = controlPoints.map(function(p) { 
          return [parseFloat(p.css('left')), parseFloat(p.css('top'))]; 
        });
        applyTransform(element, originalPos, currentPos, callback);
        $element.css('pointer-events', 'auto');
      }
    });
  });
}

// 重新定位控制点，匹配视频的视觉位置
function repositionControlPoints(element) {
  var $ = jQuery;
  var $element = $(element);
  var elementId = element.id || 'video_0';
  var controlPoints = controlPointsStore[elementId];
  
  if (!controlPoints) return;
  
  // 获取视频的视觉位置
  var rect = element.getBoundingClientRect();
  
  // 重新定位四个控制点
  var positions = ['left top', 'left bottom', 'right top', 'right bottom'];
  controlPoints.forEach(function(cp, idx) {
    var position = positions[idx];
    var x = rect.left;
    var y = rect.top;
    if (position.includes('right')) x = rect.right - 10;
    if (position.includes('bottom')) y = rect.bottom - 10;
    
    cp.css({
      left: x + 'px',
      top: y + 'px'
    });
  });
}
		
	</script>
	
	
	
   <script>
  // 初始化可变换控件
  makeTransformable('.video', function(element, H) {});

  var video = document.getElementById('video'); 		
  var video1 = document.getElementById('video1'); 	

	function updateOpacity(value) {
	 var image = document.getElementById('box');
	 opacity= value/100;
	 image.style.opacity = opacity;
	}

function aTrans(){
  var image = document.getElementById('box');
  var s = document.getElementById('slider');
  var temp = parseFloat(s.value) - parseFloat(5);
  s.value = temp;
  opacity= temp/100;
  image.style.opacity = opacity;
}

function mTrans(){
  var image = document.getElementById('box');
  var s = document.getElementById('slider');
  var temp = parseFloat(s.value) + parseFloat(5);
  s.value = temp;
  opacity= temp/100;
  image.style.opacity = opacity;
}

var fileUpload = document.getElementById('file-upload');
fileUpload.addEventListener('change', function(event) {
  var file = event.target.files[0];
  var reader = new FileReader();
  reader.onload = function(event) {
    var image = new Image();
    var image2 = new Image(); 
    image.onload = function() {
      var width = image.width;
      var height = image.height;
      var uploadStatus = document.getElementById('uploadStatus');
      uploadStatus.textContent = 'Width: ' + width + 'px, Height: ' + height + 'px' + ' ,Rate: '+width/height;
	  
      var canvas = document.createElement('canvas');
      var context = canvas.getContext('2d');
      canvas.width = getLarger(image.width,image.height);
      canvas.height = getLarger(image.width,image.height);
      context.drawImage(image, 0, 0);
	  
      var canvas2 = document.createElement('canvas');
      var context2 = canvas2.getContext('2d');
      canvas2.width = getLarger(image.width,image.height);
      canvas2.height = getLarger(image.width,image.height);
      context2.drawImage(image2, 0, 0);

      // 绘制辅助线
      context2.beginPath();
	  context2.moveTo(0,canvas.height/2);
      context2.lineTo(canvas.width,canvas.height/2);
      context2.strokeStyle = 'black';
      context2.lineWidth = 4;
      context2.stroke();
      context2.beginPath(); 
	  context2.moveTo(canvas.width/2, 0);
      context2.lineTo(canvas.width/2, canvas.height);
      context2.strokeStyle = 'black';
      context2.lineWidth = 4;
      context2.stroke();
	  
      // 绘制红色辅助线（1/4）
      context2.beginPath();
	  context2.moveTo(0,canvas.height/4);
      context2.lineTo(canvas.width,canvas.height/4);
      context2.strokeStyle = 'red';
      context2.lineWidth = 2;
      context2.stroke();
      context2.beginPath(); 
	  context2.moveTo(canvas.width/4, 0);
      context2.lineTo(canvas.width/4, canvas.height);
      context2.strokeStyle = 'red';
      context2.lineWidth = 2;
      context2.stroke();

      context2.beginPath();
	  context2.moveTo(0,canvas.height/4*3);
      context2.lineTo(canvas.width,canvas.height/4*3);
      context2.strokeStyle = 'red';
      context2.lineWidth = 2;
      context2.stroke();
      context2.beginPath(); 
	  context2.moveTo(canvas.width/4*3, 0);
      context2.lineTo(canvas.width/4*3, canvas.height);
      context2.strokeStyle = 'red';
      context2.lineWidth = 2;
      context2.stroke();
	  
      // 绘制红色辅助线（1/8）
      context2.beginPath();
	  context2.moveTo(0,canvas.height/8*7);
      context2.lineTo(canvas.width,canvas.height/8*7);
      context2.strokeStyle = 'red';
      context2.lineWidth = 2;
      context2.stroke();
      context2.beginPath(); 
	  context2.moveTo(canvas.width/8*7, 0);
      context2.lineTo(canvas.width/8*7, canvas.height);
      context2.strokeStyle = 'red';
      context2.lineWidth = 2;
      context2.stroke();

      context2.beginPath();
	  context2.moveTo(0,canvas.height/8*5);
      context2.lineTo(canvas.width,canvas.height/8*5);
      context2.strokeStyle = 'red';
      context2.lineWidth = 2;
      context2.stroke();
      context2.beginPath(); 
	  context2.moveTo(canvas.width/8*5, 0);
      context2.lineTo(canvas.width/8*5, canvas.height);
      context2.strokeStyle = 'red';
      context2.lineWidth = 2;
      context2.stroke();

      context2.beginPath();
	  context2.moveTo(0,canvas.height/8*3);
      context2.lineTo(canvas.width,canvas.height/8*3);
      context2.strokeStyle = 'red';
      context2.lineWidth = 2;
      context2.stroke();
      context2.beginPath(); 
	  context2.moveTo(canvas.width/8*3, 0);
      context2.lineTo(canvas.width/8*3, canvas.height);
      context2.strokeStyle = 'red';
      context2.lineWidth = 2;
      context2.stroke();
	  
      context2.beginPath();
	  context2.moveTo(0,canvas.height/8*1);
      context2.lineTo(canvas.width,canvas.height/8*1);
      context2.strokeStyle = 'red';
      context2.lineWidth = 2;
      context2.stroke();
      context2.beginPath(); 
	  context2.moveTo(canvas.width/8*1, 0);
      context2.lineTo(canvas.width/8*1, canvas.height);
      context2.strokeStyle = 'red';
      context2.lineWidth = 2;
      context2.stroke();

      // 更新图片显示
      var box = document.querySelector('.box');
	  box.style.width = getLarger(image.width,image.height)+"px";
	  box.style.height = getLarger(image.width,image.height)+"px";
      box.style.backgroundImage = 'url(' + canvas.toDataURL() + ')';
	  
      var box2 = document.querySelector('.box2');
	  box2.style.width = getLarger(image.width,image.height)+"px";
	  box2.style.height = getLarger(image.width,image.height)+"px";
      box2.style.backgroundImage = 'url(' + canvas2.toDataURL() + ')';
    };

    image.src = event.target.result;
  };
  reader.readAsDataURL(file);
});	

function getLarger(x, y) {
  return x > y ? x : y;
}		

var interval;
var opacity;
function flash_Image() {
  var image = document.getElementById('box');
  var slider = document.getElementById('slider');
  opacity= slider.value / 100;

  if (interval) {
    clearInterval(interval);
    image.style.opacity = opacity;
    interval = null;
  } else {
    interval = setInterval(function() {
      image.style.opacity = image.style.opacity === '0' ? opacity : '0';
    }, 800);
  }
}

function moveLeft() {
  box2.style.left = box.style.left;
  box2.style.top = box.style.top;
  var currentLeft = parseFloat(box.style.left) || 0;
  box.style.left = (currentLeft - 5) + 'px';
  box2.style.left = (currentLeft - 5) + 'px';
}

function moveRight() {
  box2.style.left = box.style.left;
  box2.style.top = box.style.top;
  var currentLeft = parseFloat(box.style.left) || 0;
  box.style.left = (currentLeft + 5) + 'px';
  box2.style.left = (currentLeft + 5) + 'px';
}

function moveUp() {
  box2.style.left = box.style.left;
  box2.style.top = box.style.top;
  var currentTop = parseFloat(box.style.top) || 0;
  box.style.top = (currentTop - 5) + 'px';     
  box2.style.top = (currentTop - 5) + 'px';
}

function moveDown() {
  box2.style.left = box.style.left;
  box2.style.top = box.style.top;
  var currentTop = parseFloat(box.style.top) || 0;
  box.style.top = (currentTop + 5) + 'px';
  box2.style.top = (currentTop + 5) + 'px';
}

document.addEventListener('keydown', function(event) {
  switch (event.key) {
    case 'a': moveLeft(); break;
    case 'd': moveRight(); break;
    case 'w': moveUp(); break;
    case 's': moveDown(); break;
    case 'i': zoomIn(); break;
    case 'o': zoomOut(); break;
	case 't': aTrans(); break;
    case 'y': mTrans(); break;
    case 'f': flash_Image(); break;
  }
});
	
function zoomIn() {
  var currentScale = box.style.transform;
  var newScale = currentScale ? parseFloat(currentScale.split('scale(')[1]) + 0.1 : 1.1;
  box.style.transform = 'scale(' + newScale + ')';
  box2.style.transform = 'scale(' + newScale + ')';
}

function zoomOut() {
  var currentScale = box.style.transform;
  var newScale = currentScale ? parseFloat(currentScale.split('scale(')[1]) - 0.1 : 0.9;
  box.style.transform = 'scale(' + newScale + ')';
  box2.style.transform = 'scale(' + newScale + ')';
}
   </script>
</body>
</html>
